<div class="bg-white rounded-lg shadow-card mb-6">
  <div class="section-header rounded-t-lg">
    <h2 class="text-lg font-semibold text-slate-800">
      <i class="fas fa-cog mr-2 text-primary"></i>Configuration
    </h2>
  </div>

  <div class="p-4 sm:p-6">
    <form action="/update_config" method="post" class="space-y-6">
      <!-- Profile Management -->
      <div class="border rounded-md p-4 bg-slate-50">
        <h3 class="text-md font-semibold mb-3 text-slate-700">
          Configuration Profiles
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
          <div>
            <label
              for="profile-select"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="Select a previously saved configuration profile to load its settings."
              >Load Profile:</label
            >
            <select
              id="profile-select"
              name="profile_select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="List of available configuration profiles."
            >
              <option value="">-- Select Profile --</option>
              {% for profile in profiles %}
              <option value="{{ profile }}">{{ profile }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex space-x-2">
            <button
              type="button"
              id="load-profile-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md text-sm flex-grow"
              title="Load the settings from the selected profile."
            >
              Load Selected
            </button>
            <button
              type="button"
              id="delete-profile-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md text-sm"
              title="Delete the selected profile."
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="mt-4">
          <label
            for="new-profile-name"
            class="block text-sm font-medium text-slate-600 mb-1"
            title="Enter a name to save the current configuration settings as a new profile."
            >Save Current as New Profile:</label
          >
          <div class="flex space-x-2">
            <input
              type="text"
              id="new-profile-name"
              placeholder="Enter new profile name"
              class="flex-grow p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Name for the new configuration profile."
            />
            <button
              type="button"
              id="save-profile-btn"
              class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-md text-sm"
              title="Save the current settings with the specified name."
            >
              Save
            </button>
          </div>
        </div>
        <div id="profile-message" class="mt-3 hidden"></div>
      </div>

      <!-- Strategy Selection -->
      <div class="border rounded-md p-4">
        <h3 class="text-md font-semibold mb-3 text-slate-700">
          Trading Strategy
        </h3>
        <div class="mb-4">
          <label
            for="strategy-select"
            class="block text-sm font-medium text-slate-600 mb-1"
            title="Choose the trading strategy the bot should use."
            >Active Strategy:</label
          >
          <select
            id="strategy-select"
            name="active_strategy_select"
            class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
            title="Select the main trading algorithm."
          >
            {% for strategy_id, strategy in available_strategies.items() %}
            <option
              value="{{ strategy_id }}"
              {%
              if
              config.active_strategy
              ==
              strategy_id
              %}selected{%
              endif
              %}
            >
              {{ strategy.name }}
            </option>
            {% endfor %}
          </select>
          <input
            type="hidden"
            id="active-strategy-input"
            name="active_strategy"
            value="{{ config.active_strategy }}"
          />
          <p id="strategy-description" class="text-sm text-slate-500 mt-2">
            {{ available_strategies[config.active_strategy].description if
            config.active_strategy in available_strategies else 'Select a
            strategy.' }}
          </p>
        </div>
      </div>

      <!-- General Settings -->
      <div class="border rounded-md p-4">
        <h3 class="text-md font-semibold mb-3 text-slate-700">
          General Settings
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label
              for="symbol"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The trading symbol (e.g., EURUSD, BTCUSDT) the bot will trade."
              >Symbol:</label
            >
            <input
              type="text"
              id="symbol"
              name="symbol"
              value="{{ config.symbol }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Enter the trading pair symbol."
            />
          </div>
          <div>
            <label
              for="timeframes"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="A JSON list of timeframes the bot will analyze (e.g., ['1h', '4h']). The first timeframe is typically the primary execution timeframe."
              >Timeframes (JSON list):</label
            >
            <input
              type="text"
              id="timeframes"
              name="timeframes"
              value="{{ config.timeframes|tojson }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Enter timeframes like '1m', '5m', '1h', '4h', '1d' in JSON list format."
            />
          </div>
          <div>
            <label
              for="lookback"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The number of historical candles to load for analysis on each timeframe."
              >Lookback Period:</label
            >
            <input
              type="number"
              id="lookback"
              name="lookback"
              value="{{ config.lookback }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Number of past candles to consider for calculations."
            />
          </div>
          <div>
            <label
              for="lot_size"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The volume of each trade placed by the bot."
              >Lot Size:</label
            >
            <input
              type="number"
              step="0.01"
              id="lot_size"
              name="lot_size"
              value="{{ config.lot_size }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Trade volume per position."
            />
          </div>
          <div>
            <label
              for="magic"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="A unique identifier number used by the bot to manage its own trades."
              >Magic Number:</label
            >
            <input
              type="number"
              id="magic"
              name="magic"
              value="{{ config.magic }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Unique ID for trades placed by this bot instance."
            />
          </div>
          <div>
            <label
              for="max_positions"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The maximum number of open positions the bot can have simultaneously."
              >Max Positions:</label
            >
            <input
              type="number"
              id="max_positions"
              name="max_positions"
              value="{{ config.max_positions }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Limit on concurrent open trades."
            />
          </div>
          <div>
            <label
              for="update_interval"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="How often (in seconds) the bot checks for new data and potential trading opportunities."
              >Update Interval (s):</label
            >
            <input
              type="number"
              id="update_interval"
              name="update_interval"
              value="{{ config.update_interval }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Frequency (in seconds) for bot execution cycle."
            />
          </div>
        </div>
      </div>

      <!-- Market Structure Strategy Settings -->
      <div
        id="market_structure-settings"
        class="strategy-settings border rounded-md p-4 {% if config.active_strategy != 'market_structure' %}hidden{% endif %}"
      >
        <h3 class="text-md font-semibold mb-3 text-slate-700">
          Market Structure Settings
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label
              for="pivot_depth"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The number of candles to the left and right required to confirm a pivot high or low."
              >Pivot Depth:</label
            >
            <input
              type="number"
              id="pivot_depth"
              name="pivot_depth"
              value="{{ config.pivot_depth }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Sensitivity for detecting swing points (higher value = fewer, more significant swings)."
            />
          </div>
          <div>
            <label
              for="break_buffer_pips"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The minimum distance (in pips) price must move beyond a structure level to be considered a valid break."
              >Break Buffer (Pips):</label
            >
            <input
              type="number"
              step="0.1"
              id="break_buffer_pips"
              name="break_buffer_pips"
              value="{{ config.break_buffer_pips }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Buffer added to structure breaks to avoid false signals."
            />
          </div>
          <div>
            <label
              for="atr_period"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The lookback period for calculating the Average True Range (ATR), used for dynamic stop loss and take profit."
              >ATR Period:</label
            >
            <input
              type="number"
              id="atr_period"
              name="atr_period"
              value="{{ config.atr_period }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Number of candles for ATR calculation."
            />
          </div>
          <div>
            <label
              for="atr_multiplier_sl"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The multiplier applied to the ATR value to determine the stop loss distance."
              >ATR Multiplier (SL):</label
            >
            <input
              type="number"
              step="0.1"
              id="atr_multiplier_sl"
              name="atr_multiplier_sl"
              value="{{ config.atr_multiplier_sl }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Factor multiplied by ATR to set stop loss."
            />
          </div>
          <div>
            <label
              for="atr_multiplier_tp"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The multiplier applied to the ATR value to determine the take profit distance."
              >ATR Multiplier (TP):</label
            >
            <input
              type="number"
              step="0.1"
              id="atr_multiplier_tp"
              name="atr_multiplier_tp"
              value="{{ config.atr_multiplier_tp }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Factor multiplied by ATR to set take profit."
            />
          </div>
          <!-- Dynamic SL Toggle -->
          <div class="flex items-center pt-5">
            <input
              type="hidden"
              name="use_dynamic_sl"
              value="false"
            />
            <!-- Hidden input for false value -->
            <input
              type="checkbox"
              id="use_dynamic_sl"
              name="use_dynamic_sl"
              value="true"
              class="h-4 w-4 text-primary border-slate-300 rounded focus:ring-primary"
              {%
              if
              config.use_dynamic_sl
              %}checked{%
              endif
              %}
            />
            <label
              for="use_dynamic_sl"
              class="ml-2 block text-sm font-medium text-slate-600"
              title="If checked, the stop loss will be placed at the most recent swing high/low instead of using the ATR multiplier."
              >Use Dynamic SL (Swing Points)</label
            >
          </div>
        </div>
      </div>

      <!-- Stochastic Strategy Settings -->
      <div
        id="stochastic-settings"
        class="strategy-settings border rounded-md p-4 {% if config.active_strategy != 'stochastic' %}hidden{% endif %}"
      >
        <h3 class="text-md font-semibold mb-3 text-slate-700">
          Stochastic Settings
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label
              for="stoch_k_period"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The lookback period for the %K line of the Stochastic oscillator."
              >K Period:</label
            >
            <input
              type="number"
              id="stoch_k_period"
              name="stoch_k_period"
              value="{{ config.stoch_k_period }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Number of periods for the Stochastic %K line."
            />
          </div>
          <div>
            <label
              for="stoch_d_period"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The period for the %D line (moving average of %K) of the Stochastic oscillator."
              >D Period:</label
            >
            <input
              type="number"
              id="stoch_d_period"
              name="stoch_d_period"
              value="{{ config.stoch_d_period }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Number of periods for the Stochastic %D line."
            />
          </div>
          <div>
            <label
              for="stoch_slowing"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The slowing period applied to the %K line, smoothing the oscillator."
              >Slowing:</label
            >
            <input
              type="number"
              id="stoch_slowing"
              name="stoch_slowing"
              value="{{ config.stoch_slowing }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Slowing factor for the Stochastic oscillator."
            />
          </div>
          <div>
            <label
              for="stoch_overbought"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The Stochastic level above which the market is considered overbought (potential sell signal)."
              >Overbought Level:</label
            >
            <input
              type="number"
              id="stoch_overbought"
              name="stoch_overbought"
              value="{{ config.stoch_overbought }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Threshold for overbought condition (e.g., 80)."
            />
          </div>
          <div>
            <label
              for="stoch_oversold"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The Stochastic level below which the market is considered oversold (potential buy signal)."
              >Oversold Level:</label
            >
            <input
              type="number"
              id="stoch_oversold"
              name="stoch_oversold"
              value="{{ config.stoch_oversold }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Threshold for oversold condition (e.g., 20)."
            />
          </div>
          <div>
            <label
              for="stoch_trend_detection"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="Method used to determine the overall trend direction (e.g., using a Simple Moving Average)."
              >Trend Detection:</label
            >
            <select
              id="stoch_trend_detection"
              name="stoch_trend_detection"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Select the indicator for trend filtering."
            >
              <option
                value="SMA"
                {%
                if
                config.stoch_trend_detection
                ==
                'SMA'
                %}selected{%
                endif
                %}
              >
                SMA
              </option>
              <!-- Add other methods if needed -->
            </select>
          </div>
          <div>
            <label
              for="stoch_trend_period"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The lookback period for the selected trend detection indicator."
              >Trend Period:</label
            >
            <input
              type="number"
              id="stoch_trend_period"
              name="stoch_trend_period"
              value="{{ config.stoch_trend_period }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Number of periods for the trend indicator (e.g., SMA period)."
            />
          </div>
        </div>
      </div>

      <!-- Trade Management Settings -->
      <div class="border rounded-md p-4">
        <h3 class="text-md font-semibold mb-3 text-slate-700">
          Trade Management
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label
              for="break_even_pips"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The profit amount (in pips) at which the stop loss will be moved to the entry price."
              >Break Even Trigger (Pips):</label
            >
            <input
              type="number"
              step="0.1"
              id="break_even_pips"
              name="break_even_pips"
              value="{{ config.break_even_pips }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Profit target in pips to trigger break even."
            />
          </div>
          <div>
            <label
              for="break_even_buffer_pips"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="An additional buffer (in pips) added to the entry price when moving the stop loss to break even, securing some profit."
              >Break Even Buffer (Pips):</label
            >
            <input
              type="number"
              step="0.1"
              id="break_even_buffer_pips"
              name="break_even_buffer_pips"
              value="{{ config.break_even_buffer_pips }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Pips added above/below entry when moving SL to break even."
            />
          </div>
          <div class="flex items-center pt-5">
            <input
              type="hidden"
              name="partial_close_enabled"
              value="false"
            />
            <input
              type="checkbox"
              id="partial_close_enabled"
              name="partial_close_enabled"
              value="true"
              class="h-4 w-4 text-primary border-slate-300 rounded focus:ring-primary"
              {%
              if
              config.partial_close_enabled
              %}checked{%
              endif
              %}
            />
            <label
              for="partial_close_enabled"
              class="ml-2 block text-sm font-medium text-slate-600"
              title="If checked, the bot will close a portion of the position when a specific profit target is reached."
              >Enable Partial Close</label
            >
          </div>
          <div>
            <label
              for="partial_close_pct"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The percentage of the position to close when the partial close trigger is hit."
              >Partial Close %:</label
            >
            <input
              type="number"
              step="1"
              min="0"
              max="100"
              id="partial_close_pct"
              name="partial_close_pct"
              value="{{ config.partial_close_pct }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Percentage (0-100) of the trade volume to close partially."
            />
          </div>
          <div>
            <label
              for="partial_close_pips"
              class="block text-sm font-medium text-slate-600 mb-1"
              title="The profit amount (in pips) required to trigger the partial close action."
              >Partial Close Trigger (Pips):</label
            >
            <input
              type="number"
              step="0.1"
              id="partial_close_pips"
              name="partial_close_pips"
              value="{{ config.partial_close_pips }}"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary"
              title="Profit target in pips to trigger partial close."
            />
          </div>
        </div>
      </div>

      <div class="flex justify-end pt-4">
        <button
          type="submit"
          class="bg-primary hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out"
          title="Save all current settings to the active configuration."
        >
          Save Configuration
        </button>
      </div>
    </form>
  </div>
</div>