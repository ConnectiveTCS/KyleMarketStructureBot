<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>Market Structure Bot Dashboard</title>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e3a8a",
              secondary: "#334155",
              success: "#059669",
              danger: "#dc2626",
              warning: "#d97706",
              info: "#0284c7",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            boxShadow: {
              card: "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1)",
              "card-hover":
                "0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1)",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .sidebar {
        min-height: calc(100vh - 2rem);
        background-color: #1e293b;
        color: #e2e8f0;
      }
      .status-badge {
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .status-running {
        background-color: #dcfce7;
        color: #15803d;
      }
      .status-stopped {
        background-color: #fee2e2;
        color: #b91c1c;
      }
      .dashboard-card {
        transition: all 0.2s ease-in-out;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .dashboard-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -4px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      .market-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
      }
      .indicator-bull {
        background-color: #059669;
      }
      .indicator-bear {
        background-color: #dc2626;
      }
      .indicator-neutral {
        background-color: #9ca3af;
      }
      header {
        background: #1e293b;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .header-brand {
        font-size: 1.25rem;
        font-weight: 700;
        color: white;
      }
      .header-btn {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.375rem;
      }
      .section-header {
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 1.5rem;
        background-color: #f8fafc;
      }
      .nav-btn.active {
        background-color: rgba(255, 255, 255, 0.1);
        border-left: 3px solid #60a5fa;
      }
      .chart-container {
        height: 300px;
        position: relative;
      }
      .metric-card {
        border-radius: 0.5rem;
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease;
      }
      .metric-card:hover {
        transform: translateY(-3px);
      }
      .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 0.5rem;
      }
      .metric-label {
        font-size: 0.875rem;
        color: #64748b;
        font-weight: 500;
      }
      .price-position-indicator {
        height: 8px;
        border-radius: 4px;
        background: #e2e8f0;
        position: relative;
        margin: 2rem 0;
      }
      .price-position-track {
        position: absolute;
        top: 0;
        height: 100%;
        background: rgba(2, 132, 199, 0.2);
        border-radius: 4px;
      }
      .price-position-handle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #0284c7;
        border: 2px solid white;
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }
      .multi-tf-indicator {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
      }

      /* Mobile-specific additional styles */
      @media (max-width: 768px) {
        .mobile-scroll-x {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        .mobile-full-width {
          width: 100% !important;
        }

        .touch-target {
          min-height: 44px;
          min-width: 44px;
        }
      }

      /* Bottom mobile navigation */
      .mobile-nav-bar {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 40;
      }

      @media (max-width: 768px) {
        .mobile-nav-bar {
          display: flex;
        }

        .mobile-pb-safe {
          padding-bottom: 5rem !important;
        }
      }

      .mobile-nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 0;
        color: #64748b;
        font-size: 0.75rem;
      }

      .mobile-nav-item.active {
        color: #1e40af;
      }

      .mobile-nav-item i {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
      }

      /* Mobile sidebar handling */
      @media (max-width: 768px) {
        .sidebar-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 50;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

        .sidebar-modal.active {
          opacity: 1;
          pointer-events: auto;
        }

        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          height: 100%;
          width: 80%;
          max-width: 320px;
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          z-index: 51;
          overflow-y: auto;
        }

        .sidebar.active {
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-800">
    <!-- Mobile sidebar overlay -->
    <div id="sidebar-modal" class="sidebar-modal"></div>

    <!-- header -->
    <header class="flex items-center justify-between px-4 sm:px-6 py-3">
      <div class="flex items-center space-x-2 sm:space-x-4">
        <button
          id="nav-toggle"
          class="md:hidden header-btn text-white hover:bg-white/10 touch-target"
        >
          <i class="fas fa-bars"></i>
        </button>
        <div class="header-brand flex items-center">
          <i class="fas fa-chart-line mr-2"></i>
          <span class="hidden sm:inline">Market Structure</span>
          <span class="inline sm:hidden">MS Bot</span>
        </div>
      </div>
      <div class="flex items-center space-x-2 sm:space-x-4">
        <span
          class="status-badge {{ 'status-running' if status=='running' else 'status-stopped' }}"
        >
          {{ status.upper() }}
        </span>
        <a
          href="/"
          class="header-btn bg-blue-500 text-white hover:bg-blue-600 touch-target flex items-center"
        >
          <i class="fas fa-sync-alt"></i>
          <span class="hidden sm:inline ml-1">Refresh</span>
        </a>
        {% if update_available %}
        <a
          href="/update_version"
          class="header-btn bg-green-500 text-white hover:bg-green-600 hidden sm:flex items-center"
        >
          <i class="fas fa-download mr-1"></i>Update
        </a>
        {% endif %}
      </div>
    </header>

    <div class="flex">
      <!-- sidebar -->
      <aside class="sidebar w-64 hidden md:block p-4">
        <!-- <div class="mb-10">
          <h1 class="text-xl font-bold text-white mb-1">
            <i class="fas fa-chart-line mr-2"></i>Market Structure
          </h1>
          <p class="text-sm text-slate-400">Trading Bot Dashboard</p>
        </div> -->

        <nav>
          <div class="mb-8">
            <p
              class="text-xs uppercase font-semibold text-slate-400 mb-4 tracking-wider"
            >
              Bot Controls
            </p>
            <div class="space-y-1">
              <a
                href="/start"
                class="flex items-center p-2 rounded hover:bg-white/10 text-green-400"
              >
                <i class="fas fa-play mr-3 w-5 text-center"></i>
                <span>Start Bot</span>
              </a>
              <a
                href="/stop"
                class="flex items-center p-2 rounded hover:bg-white/10 text-red-400"
              >
                <i class="fas fa-stop mr-3 w-5 text-center"></i>
                <span>Stop Bot</span>
              </a>
              <a
                href="/"
                class="flex items-center p-2 rounded hover:bg-white/10 text-blue-400"
              >
                <i class="fas fa-sync-alt mr-3 w-5 text-center"></i>
                <span>Refresh Data</span>
              </a>
            </div>
          </div>

          <div class="mb-8">
            <p
              class="text-xs uppercase font-semibold text-slate-400 mb-4 tracking-wider"
            >
              Monitoring
            </p>
            <div class="space-y-1">
              <button
                onclick="showSection('market_structure')"
                class="nav-btn flex items-center p-2 rounded hover:bg-white/10 w-full text-left"
              >
                <i class="fas fa-chart-bar mr-3 w-5 text-center"></i>
                <span>Market Structure</span>
              </button>
              <!-- Add Stochastic Dashboard button when active strategy is stochastic -->
              {% if config.active_strategy == 'stochastic' %}
              <button
                onclick="showSection('stochastic_dashboard')"
                class="nav-btn flex items-center p-2 rounded hover:bg-white/10 w-full text-left"
              >
                <i class="fas fa-wave-square mr-3 w-5 text-center"></i>
                <span>Stochastic Dashboard</span>
              </button>
              {% endif %}
              <button
                onclick="showSection('positions')"
                class="nav-btn flex items-center p-2 rounded hover:bg-white/10 w-full text-left"
              >
                <i class="fas fa-list-ul mr-3 w-5 text-center"></i>
                <span>Open Positions</span>
              </button>
              <button
                onclick="showSection('history')"
                class="nav-btn flex items-center p-2 rounded hover:bg-white/10 w-full text-left"
              >
                <i class="fas fa-history mr-3 w-5 text-center"></i>
                <span>Trading History</span>
              </button>
              <button
                onclick="showSection('logs')"
                class="nav-btn flex items-center p-2 rounded hover:bg-white/10 w-full text-left"
              >
                <i class="fas fa-terminal mr-3 w-5 text-center"></i>
                <span>System Logs</span>
              </button>
              <button
                onclick="showSection('account')"
                class="nav-btn flex items-center p-2 rounded hover:bg-white/10 w-full text-left"
              >
                <i class="fas fa-wallet mr-3 w-5 text-center"></i>
                <span>Account Info</span>
              </button>
              <button
                onclick="showSection('config')"
                class="nav-btn flex items-center p-2 rounded hover:bg-white/10 w-full text-left"
              >
                <i class="fas fa-cog mr-3 w-5 text-center"></i>
                <span>Configuration</span>
              </button>
            </div>
          </div>
        </nav>
      </aside>

      <!-- main content -->
      <main class="flex-1 overflow-auto p-4 sm:p-6 mobile-pb-safe">
        <!-- Dashboard Sections -->
        <div class="section-container">
          <div id="market_structure" class="dashboard-section">
            {% include 'partials/market_structure.partial.html' %}
          </div>

          <!-- Add a new section for Stochastic Dashboard -->
          <div id="stochastic_dashboard" class="dashboard-section hidden">
            <!-- Executive Dashboard Header -->
            <div
              class="bg-gradient-to-r from-slate-800 to-slate-700 text-white rounded-t-lg p-4 sm:p-5 flex flex-wrap sm:flex-nowrap justify-between items-center"
            >
              <h2 class="text-lg sm:text-xl font-bold w-full sm:w-auto">
                <i class="fas fa-wave-square mr-2"></i>Stochastic Dashboard
                <span
                  class="text-blue-300 text-sm sm:text-base block sm:inline mt-1 sm:mt-0"
                  >{{ symbol }}</span
                >
              </h2>
              <div
                class="flex items-center mt-2 sm:mt-0 w-full sm:w-auto justify-end space-x-2"
              >
                <a
                  href="/chart/{{ symbol }}"
                  class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-2.5 py-1 rounded flex items-center"
                >
                  <i class="fas fa-chart-line mr-1"></i>
                  <span>View Chart</span>
                </a>
                <span class="bg-blue-500 text-xs font-bold px-2.5 py-1 rounded"
                  >LIVE</span
                >
              </div>
            </div>

            <!-- Key Metrics Bar -->
            <div
              class="bg-white grid grid-cols-2 sm:grid-cols-4 divide-y sm:divide-y-0 sm:divide-x divide-slate-200 shadow-md"
            >
              <div class="p-3 sm:p-5 text-center">
                <p
                  class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
                >
                  Signal Status
                </p>
                <div class="flex justify-center items-center">
                  <div
                    class="w-3 h-3 rounded-full mt-1 mr-2 {% if stochastic and stochastic.signal == 'buy' %}bg-emerald-500 {% elif stochastic and stochastic.signal == 'sell' %}bg-red-500 {% else %}bg-slate-400{% endif %}"
                  ></div>
                  <p
                    class="text-base sm:text-lg font-bold {% if stochastic and stochastic.signal == 'buy' %}text-emerald-600 {% elif stochastic and stochastic.signal == 'sell' %}text-red-600 {% else %}text-slate-600{% endif %}"
                  >
                    {{ stochastic.signal|title if stochastic and
                    stochastic.signal else 'No Signal' }}
                  </p>
                </div>
              </div>
              <div class="p-3 sm:p-5 text-center">
                <p
                  class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
                >
                  Current Price
                </p>
                <p class="text-base sm:text-lg font-bold">
                  {{ current_price }}
                </p>
              </div>
              <div class="p-3 sm:p-5 text-center">
                <p
                  class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
                >
                  Trend Direction
                </p>
                <p
                  class="text-base sm:text-lg font-bold {% if stochastic and stochastic.trend == 'uptrend' %}text-emerald-600 {% elif stochastic and stochastic.trend == 'downtrend' %}text-red-600 {% else %}text-slate-600{% endif %}"
                >
                  {{ stochastic.trend|title if stochastic and stochastic.trend
                  else 'Neutral' }}
                </p>
              </div>
              <div class="p-3 sm:p-5 text-center">
                <p
                  class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
                >
                  Positions
                </p>
                <p class="text-base sm:text-lg font-bold">
                  {{ positions|length if positions else 0 }}
                </p>
              </div>
            </div>

            <!-- Dashboard Main Content -->
            <div class="p-4 sm:p-6 bg-slate-50 mt-4 sm:mt-6">
              <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6">
                <!-- Include the Stochastic Dashboard Template -->
                {% include 'stochastic_dashboard.html' %}

                <!-- Current Status Card -->
                <div class="col-span-1 lg:col-span-4">
                  <!-- Use the existing status card -->
                  <div class="bg-white rounded-lg shadow-card h-full">
                    <div class="border-b p-4">
                      <h3 class="font-semibold text-slate-800">
                        Signal Status
                      </h3>
                    </div>
                    <div class="p-5">
                      <div class="space-y-3">
                        <!-- Stochastic Specific Conditions -->
                        <div class="flex items-center">
                          <div
                            class="w-8 h-8 rounded-full flex items-center justify-center {% if stochastic and stochastic.trend %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                          >
                            <i
                              class="fas {% if stochastic and stochastic.trend %}fa-check{% else %}fa-times{% endif %}"
                            ></i>
                          </div>
                          <div class="ml-3">
                            <p class="font-medium text-slate-800">
                              Trend Direction Detected
                            </p>
                            <p class="text-xs text-slate-500">
                              {% if stochastic and stochastic.trend %} {{
                              stochastic.trend|title }} detected using {{
                              config.stoch_trend_detection }} {% else %} No
                              clear trend detected {% endif %}
                            </p>
                          </div>
                        </div>

                        <div class="flex items-center">
                          <div
                            class="w-8 h-8 rounded-full flex items-center justify-center {% if stochastic and stochastic.k_value is not none and (stochastic.k_value < config.stoch_oversold or stochastic.k_value > config.stoch_overbought) %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                          >
                            <i
                              class="fas {% if stochastic and stochastic.k_value is not none and (stochastic.k_value < config.stoch_oversold or stochastic.k_value > config.stoch_overbought) %}fa-check{% else %}fa-times{% endif %}"
                            ></i>
                          </div>
                          <div class="ml-3">
                            <p class="font-medium text-slate-800">
                              Extreme Level Reached
                            </p>
                            <p class="text-xs text-slate-500">
                              Stochastic in overbought or oversold zone
                            </p>
                          </div>
                        </div>

                        <div class="flex items-center">
                          <div
                            class="w-8 h-8 rounded-full flex items-center justify-center {% if stochastic and stochastic.signal %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                          >
                            <i
                              class="fas {% if stochastic and stochastic.signal %}fa-check{% else %}fa-times{% endif %}"
                            ></i>
                          </div>
                          <div class="ml-3">
                            <p class="font-medium text-slate-800">
                              Crossover Signal
                            </p>
                            <p class="text-xs text-slate-500"></p>
                          </div>
                        </div>
                      </div>

                      <!-- Ready Status -->
                      <div
                        class="mt-5 p-3 text-center rounded {% if stochastic and stochastic.signal and positions|length < config.max_positions %}bg-emerald-100 text-emerald-800 {% elif positions|length >= config.max_positions %}bg-yellow-100 text-yellow-800 {% else %}bg-slate-100 text-slate-600{% endif %}"
                      >
                        <p class="font-semibold">
                          {% if stochastic and stochastic.signal and
                          positions|length < config.max_positions %} Ready to
                          Trade {% elif positions|length >= config.max_positions
                          %} Maximum Positions Reached {% else %} Waiting for
                          Signal {% endif %}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="positions" class="dashboard-section hidden">
            {% include 'partials/open_positions.partial.html' %}
          </div>

          <div id="history" class="dashboard-section hidden">
            {% include 'partials/trading_history.partial.html' %}
          </div>

          <div id="logs" class="dashboard-section hidden">
            {% include 'partials/system_logs.partial.html' %}
          </div>

          <div id="account" class="dashboard-section hidden">
            {% include 'partials/account_info.partial.html' %}
          </div>

          <div id="config" class="dashboard-section hidden">
            {% include 'partials/configuration.partial.html' %}
          </div>

          <!-- Include the backtest section -->
          {% include 'backtest_section.html' %}
        </div>
      </main>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav-bar">
      <button
        onclick="showSection('market_structure')"
        class="mobile-nav-item"
        id="mobile-nav-market"
      >
        <i class="fas fa-chart-bar"></i>
        <span>Market</span>
      </button>
      {% if config.active_strategy == 'stochastic' %}
      <button
        onclick="showSection('stochastic_dashboard')"
        class="mobile-nav-item"
        id="mobile-nav-stochasticdashboard"
      >
        <i class="fas fa-wave-square"></i>
        <span>Stoch</span>
      </button>
      {% endif %}
      <button
        onclick="showSection('positions')"
        class="mobile-nav-item"
        id="mobile-nav-positions"
      >
        <i class="fas fa-list-ul"></i>
        <span>Positions</span>
      </button>
      <a href="/chart/{{ symbol }}" class="mobile-nav-item">
        <i class="fas fa-chart-line"></i>
        <span>Chart</span>
      </a>
      <button
        onclick="showSection('history')"
        class="mobile-nav-item"
        id="mobile-nav-history"
      >
        <i class="fas fa-history"></i>
        <span>History</span>
      </button>
      <button
        onclick="showSection('config')"
        class="mobile-nav-item"
        id="mobile-nav-config"
      >
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </button>
    </div>

    <script>
      // Enhanced mobile sidebar handling
      document.addEventListener('DOMContentLoaded', function() {
        const navToggle = document.getElementById('nav-toggle');
        const sidebar = document.querySelector('.sidebar');
        const sidebarModal = document.getElementById('sidebar-modal');

        navToggle.addEventListener('click', function() {
          sidebar.classList.toggle('hidden');
          sidebar.classList.toggle('active');
          sidebarModal.classList.toggle('active');
          document.body.classList.toggle('overflow-hidden');
        });

        sidebarModal.addEventListener('click', function() {
          sidebar.classList.add('hidden');
          sidebar.classList.remove('active');
          sidebarModal.classList.remove('active');
          document.body.classList.remove('overflow-hidden');
        });
      });

      // Enhanced navigation with mobile support
      function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.dashboard-section').forEach(section => {
          section.classList.add('hidden');
        });

        // Show selected section
        document.getElementById(sectionId).classList.remove('hidden');

        // Update sidebar nav buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        const activeButton = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
        if (activeButton) {
          activeButton.classList.add('active');
        }

        // Update mobile nav buttons
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
          item.classList.remove('active');
        });

        document.getElementById(`mobile-nav-${sectionId.replace('_', '')}`).classList.add('active');

        // Close sidebar on mobile if open
        const sidebar = document.querySelector('.sidebar');
        const sidebarModal = document.getElementById('sidebar-modal');
        if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
          sidebar.classList.add('hidden');
          sidebar.classList.remove('active');
          sidebarModal.classList.remove('active');
          document.body.classList.remove('overflow-hidden');
        }

        // Update URL hash
        history.pushState(null, null, '#' + sectionId);
      }

      // Set initial section and mobile nav state
      document.addEventListener("DOMContentLoaded", function() {
        let sectionId = 'market_structure';

        if (window.location.hash) {
          const hash = window.location.hash.substring(1);
          if (document.getElementById(hash)) {
            sectionId = hash;
          }
        }

        showSection(sectionId);

        // Initialize mobile nav
        const mobileNav = document.getElementById(`mobile-nav-${sectionId.replace('_', '')}`);
        if (mobileNav) {
          mobileNav.classList.add('active');
        }
      });

      // Existing profile management code
      document.addEventListener("DOMContentLoaded", function() {
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const loadProfileBtn = document.getElementById('load-profile-btn');
        const deleteProfileBtn = document.getElementById('delete-profile-btn');
        const profileSelect = document.getElementById('profile-select');
        const newProfileName = document.getElementById('new-profile-name');
        const profileMessage = document.getElementById('profile-message');

        // Show message function
        function showMessage(message, type) {
          profileMessage.innerHTML = `
            <div class="p-3 rounded ${type === 'success' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
              <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
              ${message}
            </div>
          `;
          profileMessage.classList.remove('hidden');
          setTimeout(() => {
            profileMessage.classList.add('hidden');
          }, 3000);
        }

        // utility: update form inputs from config object
        function updateConfigForm(cfg) {
          console.debug('[DEBUG] updateConfigForm with cfg:', cfg);
          Object.entries(cfg).forEach(([key, val]) => {
            const field = document.querySelector(`#config form [name="${key}"]`);
            if (!field) return;
            if (field.tagName === 'SELECT') {
              field.value = val;
            } else {
              field.value = Array.isArray(val) ? JSON.stringify(val) : val;
            }
          });
        }

        // auto-load and fill config on profile select change
        profileSelect.addEventListener('change', function() {
          const name = this.value;
          console.debug('[DEBUG] Profile select changed to:', name);
          if (!name) return;
          fetch(`/load_profile?name=${encodeURIComponent(name)}`)
            .then(r => r.json())
            .then(data => {
              console.debug('[DEBUG] load_profile response:', data);
              if (data.success) {
                fetch('/get_config')
                  .then(r => r.json())
                  .then(resp => {
                    console.debug('[DEBUG] get_config response:', resp);
                    if (resp.success) updateConfigForm(resp.config);
                  })
                  .catch(err => console.error('[DEBUG] get_config error:', err));
              }
            })
            .catch(err => console.error('[DEBUG] load_profile error:', err));
        });

        // Save profile
        saveProfileBtn.addEventListener('click', function() {
          const profileName = newProfileName.value.trim();
          if (!profileName) {
            showMessage('Please enter a profile name', 'error');
            return;
          }

          fetch('/save_profile', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: profileName })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showMessage(`Profile "${profileName}" saved successfully`, 'success');

              // Add new profile to select if not exists
              if (!Array.from(profileSelect.options).find(opt => opt.value === profileName)) {
                const option = document.createElement('option');
                option.value = profileName;
                option.textContent = profileName;
                profileSelect.appendChild(option);
              }

              // Select the newly saved profile
              profileSelect.value = profileName;
              newProfileName.value = '';
            } else {
              showMessage(data.message || 'Failed to save profile', 'error');
            }
          })
          .catch(error => {
            showMessage('An error occurred while saving the profile', 'error');
            console.error('Error:', error);
          });
        });

        // Load profile
        loadProfileBtn.addEventListener('click', function() {
          const profileName = profileSelect.value;
          if (!profileName) {
            showMessage('Please select a profile to load', 'error');
            return;
          }

          fetch(`/load_profile?name=${encodeURIComponent(profileName)}`)
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showMessage(`Profile "${profileName}" loaded successfully`, 'success');
                // Reload the page to reflect the new configuration if instructed by backend
                if (data.reload) {
                  setTimeout(() => {
                    window.location.reload();
                  }, 1000);
                }
              } else {
                showMessage(data.message || 'Failed to load profile', 'error');
              }
            })
            .catch(error => {
              showMessage('An error occurred while loading the profile', 'error');
              console.error('Error:', error);
            });
        });

        // Delete profile
        deleteProfileBtn.addEventListener('click', function() {
          const profileName = profileSelect.value;
          if (!profileName) {
            showMessage('Please select a profile to delete', 'error');
            return;
          }

          if (confirm(`Are you sure you want to delete the profile "${profileName}"?`)) {
            fetch(`/delete_profile?name=${encodeURIComponent(profileName)}`)
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  showMessage(`Profile "${profileName}" deleted successfully`, 'success');

                  // Remove the option from the select
                  const option = Array.from(profileSelect.options).find(opt => opt.value === profileName);
                  if (option) {
                    profileSelect.removeChild(option);
                  }

                  profileSelect.value = '';
                } else {
                  showMessage(data.message || 'Failed to delete profile', 'error');
                }
              })
              .catch(error => {
                showMessage('An error occurred while deleting the profile', 'error');
                console.error('Error:', error);
              });
          }
        });
      });

      // Strategy selection handling
      document.addEventListener("DOMContentLoaded", function() {
        const strategySelect = document.getElementById('strategy-select');
        const activeStrategyInput = document.getElementById('active-strategy-input');
        const strategyDescription = document.getElementById('strategy-description');
        const strategySettings = document.querySelectorAll('.strategy-settings');

        // Strategy descriptions
        const strategyDescriptions = {
          {% for strategy_id, strategy in available_strategies.items() %}
            "{{ strategy_id }}": `{{ strategy.description }}`,
          {% endfor %}
        };

        // Handle strategy selection change
        strategySelect.addEventListener('change', function() {
          const selectedStrategy = this.value;

          // Update hidden input
          activeStrategyInput.value = selectedStrategy;

          // Update strategy description
          strategyDescription.textContent = strategyDescriptions[selectedStrategy] || 'No description available';

          // Show/hide strategy-specific settings
          strategySettings.forEach(section => {
            section.classList.add('hidden');
          });

          const selectedSettings = document.getElementById(`${selectedStrategy}-settings`);
          if (selectedSettings) {
            selectedSettings.classList.remove('hidden');
          }
        });
      });
    </script>

    <!-- Chart.js for equity curve visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom backtest JS -->
    <script src="{{ url_for('static', filename='js/backtest.js') }}"></script>
  </body>
</html>
