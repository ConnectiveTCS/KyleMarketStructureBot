<!-- Executive Dashboard Header -->
<div
  class="bg-gradient-to-r from-slate-800 to-slate-700 text-white rounded-t-lg p-4 sm:p-5 flex flex-wrap sm:flex-nowrap justify-between items-center"
>
  <h2 class="text-lg sm:text-xl font-bold w-full sm:w-auto">
    <i class="fas fa-chart-bar mr-2"></i>Market Structure
    <span
      class="text-blue-300 text-sm sm:text-base block sm:inline mt-1 sm:mt-0"
      >{{ symbol }}</span
    >
  </h2>
  <div
    class="flex items-center mt-2 sm:mt-0 w-full sm:w-auto justify-end space-x-2"
  >
    <a
      href="/chart/{{ symbol }}"
      class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-2.5 py-1 rounded flex items-center"
    >
      <i class="fas fa-chart-line mr-1"></i>
      <span>View Chart</span>
    </a>
    <span class="bg-blue-500 text-xs font-bold px-2.5 py-1 rounded">LIVE</span>
  </div>
</div>

<!-- Key Metrics Bar -->
<div
  class="bg-white grid grid-cols-2 sm:grid-cols-4 divide-y sm:divide-y-0 sm:divide-x divide-slate-200 shadow-md"
>
  <div class="p-3 sm:p-5 text-center">
    <p
      class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
    >
      Overall Direction
    </p>
    <div class="flex justify-center items-center">
      <div
        class="w-3 h-3 rounded-full mt-1 mr-2 {% if overall_direction=='bull' %}bg-emerald-500{% elif overall_direction=='bear' %}bg-red-500{% else %}bg-slate-400{% endif %}"
      ></div>
      <p
        class="text-base sm:text-lg font-bold {% if overall_direction=='bull' %}text-emerald-600{% elif overall_direction=='bear' %}text-red-600{% else %}text-slate-600{% endif %}"
      >
        {{ overall_direction|default('Neutral')|title }}
      </p>
    </div>
  </div>
  <div class="p-3 sm:p-5 text-center">
    <p
      class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
    >
      Current Price
    </p>
    <p class="text-base sm:text-lg font-bold">{{ current_price }}</p>
  </div>
  <div class="p-3 sm:p-5 text-center">
    <p
      class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
    >
      Daily Change
    </p>
    <p
      class="text-base sm:text-lg font-bold {% if current_price and last_pivot_high and current_price > last_pivot_high %}text-emerald-600{% elif current_price and last_pivot_low and current_price < last_pivot_low %}text-red-600{% else %}text-slate-600{% endif %}"
    >
      <i
        class="fas {% if current_price and last_pivot_high and current_price > last_pivot_high %}fa-arrow-up{% elif current_price and last_pivot_low and current_price < last_pivot_low %}fa-arrow-down{% else %}fa-minus{% endif %} mr-1"
      ></i>
      {% if current_price and last_pivot_high and current_price >
      last_pivot_high %}+{{ ((current_price - last_pivot_high) / last_pivot_high
      * 100)|round(2) }}% {% elif current_price and last_pivot_low and
      current_price < last_pivot_low %}-{{ ((last_pivot_low - current_price) /
      last_pivot_low * 100)|round(2) }}% {% else %}0.00%{% endif %}
    </p>
  </div>
  <div class="p-3 sm:p-5 text-center">
    <p
      class="text-xs uppercase tracking-wider text-slate-500 mb-1 sm:mb-2 font-medium"
    >
      Positions
    </p>
    <p class="text-base sm:text-lg font-bold">
      {{ positions|length if positions else 0 }}
    </p>
  </div>
</div>

<!-- Dashboard Main Content -->
<div class="p-4 sm:p-6 bg-slate-50 mt-4 sm:mt-6">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6">
    <!-- Multi-Timeframe Analysis Card -->
    <div class="col-span-1 lg:col-span-8">
      <div class="bg-white rounded-lg shadow-card h-full">
        <div class="border-b p-3 sm:p-4">
          <h3 class="font-semibold text-slate-800">Multi-Timeframe Analysis</h3>
        </div>
        <div class="p-3 sm:p-5">
          <!-- Timeframe Signals Panel -->
          <div class="flex flex-wrap justify-center">
            {% if market_structures %} {% for ms in market_structures %}
            <div
              class="w-1/3 md:w-1/4 lg:w-1/6 mb-5 flex flex-col items-center"
            >
              <div
                class="multi-tf-indicator {% if ms.market_direction=='bull' %}bg-emerald-100 text-emerald-600 {% elif ms.market_direction=='bear' %}bg-red-100 text-red-600 {% else %}bg-slate-100 text-slate-600{% endif %}"
              >
                <i
                  class="fas {% if ms.market_direction=='bull' %}fa-arrow-up {% elif ms.market_direction=='bear' %}fa-arrow-down {% else %}fa-minus{% endif %} text-xl sm:text-2xl"
                ></i>
              </div>
              <p class="font-bold text-xs text-center">{{ ms.timeframe }}</p>
              <p class="text-xs text-center text-slate-500">
                {{ ms.market_direction|default('Neutral')|title }}
              </p>
            </div>
            {% endfor %} {% else %}
            <div class="w-full p-4 text-center text-slate-500">
              <i class="fas fa-info-circle mr-2"></i>No market structure data
              available
            </div>
            {% endif %}
          </div>

          <!-- Market Strength Gauge -->
          <div class="mt-6 sm:mt-8 border-t pt-4 sm:pt-6">
            <h4 class="font-medium text-sm mb-3 sm:mb-4 text-slate-700">
              Market Strength
            </h4>
            <div class="h-4 bg-slate-200 rounded-full overflow-hidden">
              {% set bull_count =
              market_structures|selectattr('market_direction', 'equalto',
              'bull')|list|length %} {% set bear_count =
              market_structures|selectattr('market_direction', 'equalto',
              'bear')|list|length %} {% set neutral_count =
              market_structures|length - bull_count - bear_count %} {% set
              bull_percent = bull_count / market_structures|length * 100 if
              market_structures else 0 %} {% set bear_percent = bear_count /
              market_structures|length * 100 if market_structures else 0 %} {%
              set neutral_percent = neutral_count / market_structures|length *
              100 if market_structures else 0 %}

              <div class="h-full flex">
                <div
                  class="bg-emerald-500 h-full"
                  style="width: {{ bull_percent }}%"
                ></div>
                <div
                  class="bg-slate-400 h-full"
                  style="width: {{ neutral_percent }}%"
                ></div>
                <div
                  class="bg-red-500 h-full"
                  style="width: {{ bear_percent }}%"
                ></div>
              </div>
            </div>
            <div class="flex justify-between mt-2 text-xs text-slate-500">
              <span>Bullish ({{ bull_count }})</span>
              <span>Neutral ({{ neutral_count }})</span>
              <span>Bearish ({{ bear_count }})</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Current Status Card -->
    <div class="col-span-1 lg:col-span-4">
      <div class="bg-white rounded-lg shadow-card h-full">
        <div class="border-b p-4">
          <h3 class="font-semibold text-slate-800">Market Status</h3>
        </div>
        <div class="p-5">
          <div class="text-center">
            <div
              class="inline-block p-5 rounded-full mb-4 {% if market_direction == 'bull' %}bg-emerald-100 text-emerald-600 {% elif market_direction == 'bear' %}bg-red-100 text-red-600 {% else %}bg-slate-100 text-slate-600{% endif %}"
            >
              <i
                class="fas {% if market_direction == 'bull' %}fa-arrow-up {% elif market_direction == 'bear' %}fa-arrow-down {% else %}fa-minus{% endif %} text-3xl"
              ></i>
            </div>
            <div
              class="text-xl font-bold mb-2 {% if market_direction == 'bull' %}text-emerald-600 {% elif market_direction == 'bear' %}text-red-600 {% else %}text-slate-600{% endif %}"
            >
              {{ market_direction|title if market_direction else 'Neutral' }}
            </div>
            <p class="text-sm text-slate-500 mb-5">
              {% if market_direction == 'bull' %} Bullish structure confirmed on
              {{ timeframe }} timeframe {% elif market_direction == 'bear' %}
              Bearish structure confirmed on {{ timeframe }} timeframe {% else
              %} No clear market structure detected {% endif %}
            </p>
          </div>

          <!-- Price Position Indicator -->
          <div class="mt-8 pt-4">
            <h4 class="text-sm font-medium mb-5 text-center text-slate-700">
              Price Position
            </h4>
            <div class="price-position-indicator">
              {% if last_pivot_high and last_pivot_low and current_price %} {%
              set range = last_pivot_high - last_pivot_low %} {% if range > 0 %}
              <!-- Calculate position with clamping to ensure it's between 0-100% -->
              {% set raw_position = (current_price - last_pivot_low) / range *
              100 %} {% set position = [0, [raw_position, 100]|min]|max %}

              <!-- Add position status labels -->
              {% set position_status = "Between Pivots" %} {% if current_price <
              last_pivot_low %} {% set position_status = "Below Pivot Low" %} {%
              elif current_price > last_pivot_high %} {% set position_status =
              "Above Pivot High" %} {% endif %}

              <div
                class="price-position-track"
                style="left: 0; width: {{ position }}%"
              ></div>
              <div
                class="price-position-handle"
                style="left: {{ position }}%"
              ></div>
              <div
                class="absolute -bottom-5 left-0 text-xs font-medium text-slate-500"
              >
                {{ last_pivot_low }}
              </div>
              <div
                class="absolute -bottom-5 right-0 text-xs font-medium text-slate-500"
              >
                {{ last_pivot_high }}
              </div>
              {% else %}
              <div
                class="h-full flex items-center justify-center text-xs text-slate-500"
              >
                Invalid pivot range (high <= low)
              </div>
              {% endif %} {% else %}
              <div
                class="h-full flex items-center justify-center text-xs text-slate-500"
              >
                No pivot data available
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Add position status display -->
          {% if last_pivot_high and last_pivot_low and current_price and
          last_pivot_high > last_pivot_low %}
          <div class="mt-2 text-center">
            <span class="text-xs text-slate-500"
              >Current Price:
              <span class="font-medium text-slate-700"
                >{{ current_price }}</span
              ></span
            >
            <span
              class="text-xs {% if current_price < last_pivot_low %}text-red-500{% elif current_price > last_pivot_high %}text-emerald-500{% else %}text-blue-500{% endif %} ml-2"
              >({{ position_status }})</span
            >
          </div>
          {% endif %}

          <div class="space-y-3">
            <!-- Buy Conditions -->
            <div class="mt-6 mb-3">
              <h4 class="text-sm font-semibold text-emerald-600 mb-2">
                Buy Conditions
              </h4>

              <!-- Buy Condition 1: Bull structure detected -->
              <div class="flex items-center py-1">
                <div
                  class="w-6 h-6 rounded-full flex items-center justify-center {% if market_direction == 'bull' %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                >
                  <i
                    class="fas {% if market_direction == 'bull' %}fa-check{% else %}fa-times{% endif %} text-xs"
                  ></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-slate-700">
                    Bullish Structure Detected
                  </p>
                </div>
              </div>

              <!-- Buy Condition 2: Price above pivot high -->
              <div class="flex items-center py-1">
                <div
                  class="w-6 h-6 rounded-full flex items-center justify-center {% if last_pivot_high and current_price and current_price > last_pivot_high %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                >
                  <i
                    class="fas {% if last_pivot_high and current_price and current_price > last_pivot_high %}fa-check{% else %}fa-times{% endif %} text-xs"
                  ></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-slate-700">
                    Price Above Previous High
                  </p>
                </div>
              </div>

              <!-- Buy Condition 3: Confirming timeframes -->
              {% set bull_count =
              market_structures|selectattr('market_direction', 'equalto',
              'bull')|list|length %} {% set is_confirmed = bull_count >= 2 %}
              <div class="flex items-center py-1">
                <div
                  class="w-6 h-6 rounded-full flex items-center justify-center {% if is_confirmed %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                >
                  <i
                    class="fas {% if is_confirmed %}fa-check{% else %}fa-times{% endif %} text-xs"
                  ></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-slate-700">
                    Multiple Timeframes Confirm ({{ bull_count }})
                  </p>
                </div>
              </div>
            </div>

            <!-- Sell Conditions -->
            <div class="mt-4 mb-3">
              <h4 class="text-sm font-semibold text-red-600 mb-2">
                Sell Conditions
              </h4>

              <!-- Sell Condition 1: Bear structure detected -->
              <div class="flex items-center py-1">
                <div
                  class="w-6 h-6 rounded-full flex items-center justify-center {% if market_direction == 'bear' %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                >
                  <i
                    class="fas {% if market_direction == 'bear' %}fa-check{% else %}fa-times{% endif %} text-xs"
                  ></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-slate-700">
                    Bearish Structure Detected
                  </p>
                </div>
              </div>

              <!-- Sell Condition 2: Price below pivot low -->
              <div class="flex items-center py-1">
                <div
                  class="w-6 h-6 rounded-full flex items-center justify-center {% if last_pivot_low and current_price and current_price < last_pivot_low %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                >
                  <i
                    class="fas {% if last_pivot_low and current_price and current_price < last_pivot_low %}fa-check{% else %}fa-times{% endif %} text-xs"
                  ></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-slate-700">Price Below Previous Low</p>
                </div>
              </div>

              <!-- Sell Condition 3: Confirming timeframes -->
              {% set bear_count =
              market_structures|selectattr('market_direction', 'equalto',
              'bear')|list|length %} {% set is_confirmed = bear_count >= 2 %}
              <div class="flex items-center py-1">
                <div
                  class="w-6 h-6 rounded-full flex items-center justify-center {% if is_confirmed %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
                >
                  <i
                    class="fas {% if is_confirmed %}fa-check{% else %}fa-times{% endif %} text-xs"
                  ></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-slate-700">
                    Multiple Timeframes Confirm ({{ bear_count }})
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-12 gap-4 sm:gap-6 mt-4 sm:mt-6">
    <!-- Market Structure Strategy Card -->
    <div class="col-span-1 md:col-span-7">
      <div class="bg-white rounded-lg shadow-card">
        <div class="border-b p-3 sm:p-4">
          <h3 class="font-semibold text-slate-800">
            Market Structure Strategy
          </h3>
        </div>
        <div class="p-3 sm:p-5">
          <div
            class="flex flex-col sm:flex-row sm:space-x-6 space-y-6 sm:space-y-0"
          >
            <div class="sm:flex-1">
              <h4 class="font-medium text-emerald-600 mb-2 flex items-center">
                <i class="fas fa-arrow-up mr-2"></i>Bullish Structure
              </h4>
              <ul class="list-disc ml-5 space-y-1 text-sm text-slate-600">
                <li>Price breaks above recent pivot high</li>
                <li>Enter long after confirmation</li>
                <li>Stop loss below recent swing low</li>
                <li>Break-even at {{ config.break_even_pips }} pips</li>
                <li>Partial close at {{ config.partial_close_pips }} pips</li>
              </ul>
            </div>
            <div class="sm:flex-1">
              <h4 class="font-medium text-red-600 mb-2 flex items-center">
                <i class="fas fa-arrow-down mr-2"></i>Bearish Structure
              </h4>
              <ul class="list-disc ml-5 space-y-1 text-sm text-slate-600">
                <li>Price breaks below recent pivot low</li>
                <li>Enter short after confirmation</li>
                <li>Stop loss above recent swing high</li>
                <li>Break-even at {{ config.break_even_pips }} pips</li>
                <li>Partial close at {{ config.partial_close_pips }} pips</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Strategy Condition Checks Card -->
    <div class="col-span-1 md:col-span-5">
      <div class="bg-white rounded-lg shadow-card h-full">
        <div class="border-b p-4">
          <h3 class="font-semibold text-slate-800">Signal Status</h3>
        </div>
        <div class="p-5">
          <div class="space-y-3">
            <!-- Condition 1 -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center {% if last_pivot_high and last_pivot_low %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
              >
                <i
                  class="fas {% if last_pivot_high and last_pivot_low %}fa-check{% else %}fa-times{% endif %}"
                ></i>
              </div>
              <div class="ml-3">
                <p class="font-medium text-slate-800">Pivot Points Detected</p>
                <p class="text-xs text-slate-500">
                  Both high and low pivots found
                </p>
              </div>
            </div>

            <!-- Condition 2 -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center {% if market_direction %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-400{% endif %}"
              >
                <i
                  class="fas {% if market_direction %}fa-check{% else %}fa-times{% endif %}"
                ></i>
              </div>
              <div class="ml-3">
                <p class="font-medium text-slate-800">
                  Structure Break Detected
                </p>
                <p class="text-xs text-slate-500">
                  Price broke structure boundary
                </p>
              </div>
            </div>

            <!-- Condition 3 -->
            <div class="flex items-center">
              <div
                class="w-8 h-8 rounded-full flex items-center justify-center {% if positions|length < config.max_positions %}bg-emerald-100 text-emerald-600{% else %}bg-yellow-100 text-yellow-600{% endif %}"
              >
                <i
                  class="fas {% if positions|length < config.max_positions %}fa-check{% else %}fa-exclamation{% endif %}"
                ></i>
              </div>
              <div class="ml-3">
                <p class="font-medium text-slate-800">Position Capacity</p>
                <p class="text-xs text-slate-500">
                  {{ positions|length }}/{{ config.max_positions }} positions
                  open
                </p>
              </div>
            </div>
          </div>

          <!-- Ready Status -->
          <div
            class="mt-5 p-3 text-center rounded {% if market_direction and positions|length < config.max_positions %}bg-emerald-100 text-emerald-800 {% elif positions|length >= config.max_positions %}bg-yellow-100 text-yellow-800 {% else %}bg-slate-100 text-slate-600{% endif %}"
          >
            <p class="font-semibold">
              {% if market_direction and positions|length < config.max_positions
              %} Ready to Trade {% elif positions|length >= config.max_positions
              %} Maximum Positions Reached {% else %} Waiting for Signal {%
              endif %}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
